{% extends 'partials/base.html' %}
{% block title %} Admin {% endblock title %}


{% block content %}
 <!-- Mapa fixo ao lado da tabela -->
<div id="map" style="height: 400px; width: 100%; margin-top: 20px; border-radius: 10px;"></div>

<div class="card" id="driversList">
  <div class="card-header align-items-center d-flex">
    <h4 class="card-title mb-0 flex-grow-1">Lista de Motoristas</h4>

    <!-- Seletor de filtro -->
    <div>
      <select id="filtroMotoristas" class="form-select form-select-sm">
        <option value="ativos" selected>Ativos</option>
        <option value="inativos">Inativos</option>
        <option value="todos">Todos</option>
      </select>
    </div>
  </div>

  <div class="card-body">
    <div class="table-responsive table-card mt-0">
      <table class="table table-centered align-middle table-nowrap mb-0">
        <thead class="text-muted table-light text-center">
          <tr>
            <th scope="col" style="width: 30%;">Nome</th>
            <th scope="col" style="width: 20%;">Status</th>
            <th scope="col" style="width: 25%;">Avaliação</th>
            <th scope="col" style="width: 5%;">Edit</th>
            <th scope="col" style="width: 5%;">Detalhes</th>
          </tr>
        </thead>

        <!-- 3 tbody: Ativos, Inativos e Todos (Todos usa os dois conjuntos) -->
        <tbody id="tbody-ativos" class="list text-center">
          {% for motorista in motoristas_ativos %}
          <tr>
            <td class="nome">{{ motorista.nome }}</td>
            <td class="status">
              {% if motorista.status == 'livre' %}
                <span class="badge bg-success-subtle text-success">Livre</span>
              {% elif motorista.status == 'em_corrida' %}
                <span class="badge bg-warning-subtle text-warning">Em Corrida</span>
              {% else %}
                <span class="badge bg-danger-subtle text-danger">Off</span>
              {% endif %}
            </td>
            <td>
              <h5 class="fs-md fw-medium mb-0 rating">
                <i class="ph-star align-baseline text-warning"></i> {{ motorista.avalicoes }}
              </h5>
            </td>
            <td>
              <button class="btn btn-sm btn-success edit-item-btn" data-id="{{ motorista.id }}">Editar</button>
            </td>
            <td>
              <ul class="d-flex gap-2 list-unstyled mb-0 justify-content-center">
                <li>
                  <a data-bs-target="#exampleModalgrid"
                     class="btn btn-subtle-primary btn-icon btn-sm"
                     data-bs-toggle="modal"
                     data-id="{{ motorista.id }}"
                     data-nome="{{ motorista.nome }}"
                     data-telefone="{{ motorista.telefone }}"
                     data-sexo="{{ motorista.sexo }}"
                     data-cpf="{{ motorista.cpf }}"
                     data-horalivre="{{ motorista.hora_livre }}"
                     data-inicio_corrida="{% if motorista.inicio_corrida %}{{ motorista.inicio_corrida.strftime('%d/%m/%Y %H:%M:%S') }}{% else %}N/A{% endif %}"
                     data-duracao_corrida="{{ motorista.duracao_corrida }}"
                     data-destino="{{ motorista.destino }}"
                     data-status="{{ motorista.status }}"
                     data-avaliacao="{{ motorista.avalicoes }}"
                     data-tipo_carro="{{ motorista.tipo_carro }}">
                    <i class="ph-eye"></i>
                  </a>
                </li>
              </ul>
            </td>
          </tr>
          {% endfor %}
        </tbody>

        <tbody id="tbody-inativos" class="list text-center" style="display:none;">
          {% for motorista in motoristas_inativos %}
          <tr>
            <td class="nome">{{ motorista.nome }}</td>
            <td class="status">
              {% if motorista.status == 'livre' %}
                <span class="badge bg-success-subtle text-success">Livre</span>
              {% elif motorista.status == 'em_corrida' %}
                <span class="badge bg-warning-subtle text-warning">Em Corrida</span>
              {% else %}
                <span class="badge bg-danger-subtle text-danger">Off</span>
              {% endif %}
            </td>
            <td>
              <h5 class="fs-md fw-medium mb-0 rating">
                <i class="ph-star align-baseline text-warning"></i> {{ motorista.avalicoes }}
              </h5>
            </td>
            <td>
              <button class="btn btn-sm btn-success edit-item-btn" data-id="{{ motorista.id }}">Editar</button>
            </td>
            <td>
              <ul class="d-flex gap-2 list-unstyled mb-0 justify-content-center">
                <li>
                  <a data-bs-target="#exampleModalgrid"
                     class="btn btn-subtle-primary btn-icon btn-sm"
                     data-bs-toggle="modal"
                     data-id="{{ motorista.id }}"
                     data-nome="{{ motorista.nome }}"
                     data-telefone="{{ motorista.telefone }}"
                     data-sexo="{{ motorista.sexo }}"
                     data-cpf="{{ motorista.cpf }}"
                     data-horalivre="{{ motorista.hora_livre }}"
                     data-inicio_corrida="{% if motorista.inicio_corrida %}{{ motorista.inicio_corrida.strftime('%d/%m/%Y %H:%M:%S') }}{% else %}N/A{% endif %}"
                     data-duracao_corrida="{{ motorista.duracao_corrida }}"
                     data-destino="{{ motorista.destino }}"
                     data-status="{{ motorista.status }}"
                     data-avaliacao="{{ motorista.avalicoes }}"
                     data-tipo_carro="{{ motorista.tipo_carro }}">
                    <i class="ph-eye"></i>
                  </a>
                </li>
              </ul>
            </td>
          </tr>
          {% endfor %}
        </tbody>

        <tbody id="tbody-todos" class="list text-center" style="display:none;">
          {% for motorista in motoristas_ativos %}
            <!-- Reuso da mesma linha (ativos) -->
            <tr>
              <td class="nome">{{ motorista.nome }}</td>
              <td class="status">
                {% if motorista.status == 'livre' %}
                  <span class="badge bg-success-subtle text-success">Livre</span>
                {% elif motorista.status == 'em_corrida' %}
                  <span class="badge bg-warning-subtle text-warning">Em Corrida</span>
                {% else %}
                  <span class="badge bg-danger-subtle text-danger">Off</span>
                {% endif %}
              </td>
              <td>
                <h5 class="fs-md fw-medium mb-0 rating">
                  <i class="ph-star align-baseline text-warning"></i> {{ motorista.avalicoes }}
                </h5>
              </td>
              <td><button class="btn btn-sm btn-success edit-item-btn" data-id="{{ motorista.id }}">Editar</button></td>
              <td>
                <ul class="d-flex gap-2 list-unstyled mb-0 justify-content-center">
                  <li>
                    <a data-bs-target="#exampleModalgrid" class="btn btn-subtle-primary btn-icon btn-sm" data-bs-toggle="modal"
                       data-id="{{ motorista.id }}" data-nome="{{ motorista.nome }}" data-telefone="{{ motorista.telefone }}"
                       data-sexo="{{ motorista.sexo }}" data-cpf="{{ motorista.cpf }}" data-horalivre="{{ motorista.hora_livre }}"
                       data-inicio_corrida="{% if motorista.inicio_corrida %}{{ motorista.inicio_corrida.strftime('%d/%m/%Y %H:%M:%S') }}{% else %}N/A{% endif %}"
                       data-duracao_corrida="{{ motorista.duracao_corrida }}" data-destino="{{ motorista.destino }}"
                       data-status="{{ motorista.status }}" data-avaliacao="{{ motorista.avalicoes }}"
                       data-tipo_carro="{{ motorista.tipo_carro }}">
                      <i class="ph-eye"></i>
                    </a>
                  </li>
                </ul>
              </td>
            </tr>
          {% endfor %}
          {% for motorista in motoristas_inativos %}
            <!-- Reuso da mesma linha (inativos) -->
            <tr>
              <td class="nome">{{ motorista.nome }}</td>
              <td class="status">
                {% if motorista.status == 'livre' %}
                  <span class="badge bg-success-subtle text-success">Livre</span>
                {% elif motorista.status == 'em_corrida' %}
                  <span class="badge bg-warning-subtle text-warning">Em Corrida</span>
                {% else %}
                  <span class="badge bg-danger-subtle text-danger">Off</span>
                {% endif %}
              </td>
              <td>
                <h5 class="fs-md fw-medium mb-0 rating">
                  <i class="ph-star align-baseline text-warning"></i> {{ motorista.avalicoes }}
                </h5>
              </td>
              <td><button class="btn btn-sm btn-success edit-item-btn" data-id="{{ motorista.id }}">Editar</button></td>
              <td>
                <ul class="d-flex gap-2 list-unstyled mb-0 justify-content-center">
                  <li>
                    <a data-bs-target="#exampleModalgrid" class="btn btn-subtle-primary btn-icon btn-sm" data-bs-toggle="modal"
                       data-id="{{ motorista.id }}" data-nome="{{ motorista.nome }}" data-telefone="{{ motorista.telefone }}"
                       data-sexo="{{ motorista.sexo }}" data-cpf="{{ motorista.cpf }}" data-horalivre="{{ motorista.hora_livre }}"
                       data-inicio_corrida="{% if motorista.inicio_corrida %}{{ motorista.inicio_corrida.strftime('%d/%m/%Y %H:%M:%S') }}{% else %}N/A{% endif %}"
                       data-duracao_corrida="{{ motorista.duracao_corrida }}" data-destino="{{ motorista.destino }}"
                       data-status="{{ motorista.status }}" data-avaliacao="{{ motorista.avalicoes }}"
                       data-tipo_carro="{{ motorista.tipo_carro }}">
                      <i class="ph-eye"></i>
                    </a>
                  </li>
                </ul>
              </td>
            </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>

    <div class="align-items-center mt-4 pt-2 row">
      <div class="col-sm">
        <div class="text-muted text-center text-sm-start">
          Mostrando <span class="fw-semibold" id="contadorMotoristas">{{ motoristas_ativos | length }}</span> motoristas
        </div>
      </div>
    </div>
  </div>
</div>
<!--end row-->

{% endblock content %}



{% block extra_content %}
<!-- Modal -->
<div class="modal fade" id="modalFilaMotoristas" tabindex="-1" aria-labelledby="modalFilaMotoristasLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalFilaMotoristasLabel">Fila de Motoristas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Posição</th>
                <th>Nome</th>
                <th>Endereço</th>
                <th>Hora Livre</th>
              </tr>
            </thead>
            <tbody>
              {% for motorista in fila %}
              <tr {% if loop.index == 1 %}class="table-primary"{% endif %}>
                <td>
                  {% if loop.index == 1 %}
                    <span class="badge bg-primary">Próximo</span>
                  {% else %}
                    {{ loop.index }}
                  {% endif %}
                </td>
                <td title="{{ motorista.nome }}">
                  {{ motorista.nome[:25] }}{{ '...' if motorista.nome|length > 25 else '' }}
                </td>
                <td title="{{ motorista.endereco }}">
                  {{ motorista.endereco|default('')|truncate(25, True, '...') }}
                </td>
                <td>
                  {% if motorista.hora_livre %}
                    {{ motorista.hora_livre.strftime('%d/%m/%Y, %H:%M:%S') }}
                  {% else %}
                    Não registrado
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->

<div class="modal fade" id="showModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light p-3">
        <h5 class="modal-title">Editar Motorista</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="form-motorista">
        <div class="modal-body">
          <input type="hidden" id="motorista-id">
          <div class="mb-3">
            <label class="form-label">Nome</label>
            <input type="text" id="nome" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Telefone</label>
            <input type="text" id="telefone" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">CPF</label>
            <input type="text" id="cpf" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Placa</label>
            <input type="text" id="placa" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Etiquetas</label>
            <div id="etiqueta-container" class="d-flex flex-wrap gap-2"></div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="btn-alterar_senha">Alterar Senha</button>
          <button type="button" class="btn btn-danger" id="btn-desativar">Desativar</button>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="exampleModalFullscreenXxlValores" tabindex="-1"  aria-labelledby="modalValoresTitulo" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="modalValoresTitulo">Cadastrar novo bairro</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <!-- Mapa -->
        <div id="mapModalValores" style="width: 100%; height: 250px; border-radius: 10px; background: #f3f3f3;"></div>

        <!-- Endereço selecionado -->
        <div class="mt-2 text-center">
          <strong id="enderecoSelecionado">Endereço selecionado</strong>
        </div>

        <!-- Formulário -->
        <div class="mt-3">
          <div class="mb-2">
            <label for="nomeBairro" class="form-label">Nome</label>
            <input type="text" class="form-control" id="nomeBairro" placeholder="Digite o nome do bairro">

          </div>

          <div class="mb-2">
            <label for="tipoBairro" class="form-label">Tipo</label>
            <select class="form-select" id="tipoBairro">
              <option value="">Selecione</option>
              <option value="centro">Centro</option>
              <option value="normal">Normal</option>
              <option value="especial">Especial</option>
              <option value="extremidade">Extremidade</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="nomesAlternativos" class="form-label">Nome alternativos</label>
            <input type="text" class="form-control" id="nomesAlternativos" placeholder="Ex: Bairro Velho, Nova Esperança...">
          </div>
        </div>
        <div class="d-flex gap-2 mt-2">
           <button type="button" class="btn btn-primary w-100" onclick="carregarBairros()">Mostrar Bairros</button>
          <button type="button" class="btn btn-success w-100" onclick="cadastrarBairro()">Confirmar</button>

        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="exampleModalFullscreenXxl" tabindex="-1" aria-labelledby="exampleModalFullscreenXxlLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalFullscreenXxlLabel">Calculadora de Distância</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Mapa para selecionar pontos -->
        <div id="mapModal" style="width: 100%; height: 250px; border-radius: 10px; background: #f3f3f3;"></div>

        <!-- Endereços (preenchidos via clique no mapa) -->
        <div class="mt-3">
          <label>Endereço de Embarque:</label>
          <input type="text" id="pickup-address" class="form-control" placeholder="Digite ou selecione no mapa" autocomplete="on">

        </div>
        <div class="mt-3">
          <label>Endereço de Destino:</label>
          <input type="text" id="destination-address" class="form-control" placeholder="Digite ou selecione no mapa" autocomplete="on">

        </div>
        <br>
        <!-- Exibição dos valores atuais (dados do banco) -->
        <div class="mt-3">
          <p class="mb-1">Valores atuais e novos (Bandeira <span id="bandeira-selecionada"></span>):</p>
          <table class="table table-bordered text-center">
            <thead>
              <tr>
                <th>Valores</th>
                <th>Atual</th>
                <th>Novo</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Mínimo</td>
                <td><input type="text" id="current-minimum" class="form-control text-center" readonly></td>
                <td><input type="text" id="new-minimum" class="form-control text-center"></td>
              </tr>
              <tr>
                <td>Base</td>
                <td><input type="text" id="current-base" class="form-control text-center"></td>
                <td><input type="text" id="new-base" class="form-control text-center"></td>
              </tr>
              <tr>
                <td>Km</td>
                <td><input type="text" id="current-km" class="form-control text-center" readonly></td>
                <td><input type="text" id="new-km" class="form-control text-center"></td>
              </tr>
              <tr>
                <td>Tempo</td>
                <td><input type="text" id="current-time" class="form-control text-center" readonly></td>
                <td><input type="text" id="new-time" class="form-control text-center"></td>
              </tr>
              <tr>
                <td>Valor</td>
                <td><input type="text" id="current-value" class="form-control text-center" readonly></td>
                <td><input type="text" id="new-value" class="form-control text-center" readonly></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Seleção da bandeira -->
        <div class="row mt-3">
          <div class="col-lg-12">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="bandeiraOptions" id="bandeira1" value="1" checked>
              <label class="form-check-label" for="bandeira1">Bandeira 1</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="bandeiraOptions" id="bandeira2" value="2">
              <label class="form-check-label" for="bandeira2">Bandeira 2</label>
            </div>
          </div>

        </div>
        <div class="row mt-3">
          <div class="col-lg-12">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="tipoCorrida" id="corridaRadio" value="corrida" checked>
              <label class="form-check-label" for="corridaRadio">Corrida</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="tipoCorrida" id="viagemRadio" value="viagem">
              <label class="form-check-label" for="viagemRadio">Viagem</label>
            </div>
          </div>
        </div>
        <!-- Botão Confirmar que atualiza os valores no banco -->
        <button type="button" class="btn btn-primary mt-3 w-100" onclick="updateTarifas()">Atualizar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="exampleModalgrid" tabindex="-1" aria-labelledby="exampleModalgridLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalgridLabel">Detalhes da Corrida</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>ID Motorista: </strong> <span id="raceId" class="badge bg-secondary"></span></p>
                <p><strong>Nome: </strong> <span id="raceNome"></span></p>
                <p><strong>Telefone: </strong> <span id="raceTelefone"></span></p>
                <p><strong>Sexo: </strong> <span id="raceSexo"></span></p>
                <p><strong>CPF: </strong> <span id="raceCpf"></span></p>
                <p><strong>Tipo de Carro: </strong> <span id="raceTipoCarro"></span></p>
                <p><strong>Hora Do Livre: </strong> <span id="raceHoraLivre"></span></p>
                <p><strong>Status: </strong> <span id="raceStatus" class="badge"></span></p>

                <!-- Apenas para status em corrida -->
                <div id="corridaInfo" style="display: none;">
                    <p><strong>Início da Corrida:</strong> <span id="raceInicioCorrida"></span></p>
                    <p><strong>Duração da Corrida:</strong> <span id="raceDuracaoCorrida"></span></p>
                    <p><strong>Destino:</strong> <span id="raceDestino"></span></p>
                </div>
            </div>
            <!-- <div class="modal-footer d-flex justify-content-between">
                <div>
                    <a id="btnMandarOff" href="#" class="btn btn-danger">Mandar o Off</a>
                  <a id="btnMandarLivre" href="#" class="btn btn-success">Mandar o Livre</a>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div> -->
        </div>
    </div>
</div>

{% endblock extra_content %}


{% block extra_js %}
    <script>
      (function () {
        const select = document.getElementById('filtroMotoristas');
        const tbodyAtivos = document.getElementById('tbody-ativos');
        const tbodyInativos = document.getElementById('tbody-inativos');
        const tbodyTodos = document.getElementById('tbody-todos');
        const contador = document.getElementById('contadorMotoristas');

        function mostrar(filtro) {
          tbodyAtivos.style.display = 'none';
          tbodyInativos.style.display = 'none';
          tbodyTodos.style.display = 'none';

          if (filtro === 'ativos') {
            tbodyAtivos.style.display = '';
            contador.textContent = tbodyAtivos.querySelectorAll('tr').length;
          } else if (filtro === 'inativos') {
            tbodyInativos.style.display = '';
            contador.textContent = tbodyInativos.querySelectorAll('tr').length;
          } else { // todos
            tbodyTodos.style.display = '';
            contador.textContent = tbodyTodos.querySelectorAll('tr').length;
          }
        }

        select.addEventListener('change', function (e) {
          mostrar(e.target.value);
        });

        // inicializa
        mostrar(select.value);
      })();
    </script>
    <script>
  document.querySelectorAll(".edit-item-btn").forEach(btn => {
  btn.addEventListener("click", async function () {
    const motoristaId = this.dataset.id;

    try {
      const res = await fetch(`/motoristas/${motoristaId}`);
      if (!res.ok) throw new Error("Erro ao buscar motorista");
      const motorista = await res.json();

      const modal = document.getElementById("showModal");
      const modalTitle = modal.querySelector(".modal-title");
      const modalBody = modal.querySelector(".modal-body");
      const modalFooter = modal.querySelector(".modal-footer");

      // Limpa modal
      modalBody.innerHTML = "";
      modalFooter.innerHTML = "";

      if (motorista.is_active) {
        // Modal completo para motoristas ativos
        modalTitle.textContent = "Editar Motorista Ativo";

        modalBody.innerHTML = `
          <input type="hidden" id="motorista-id" value="${motorista.id}">
          <div class="mb-3"><label class="form-label">Nome</label><input type="text" id="nome" class="form-control" value="${motorista.nome || ''}"></div>
          <div class="mb-3"><label class="form-label">Telefone</label><input type="text" id="telefone" class="form-control" value="${motorista.telefone || ''}"></div>
          <div class="mb-3"><label class="form-label">CPF</label><input type="text" id="cpf" class="form-control" value="${motorista.cpf || ''}"></div>
          <div class="mb-3"><label class="form-label">Placa</label><input type="text" id="placa" class="form-control" value="${motorista.placa || ''}"></div>
          <div class="mb-3"><label class="form-label">Etiquetas</label><div id="etiqueta-container" class="d-flex flex-wrap gap-2"></div></div>
        `;

          // Monta checkboxes
          const container = modalBody.querySelector("#etiqueta-container");
          const etiquetasRes = await fetch("/motoristas/etiquetas");
          const etiquetas = await etiquetasRes.json();

          // Garante que motorista.etiqueta exista e seja array
          const etiquetasMotorista = Array.isArray(motorista.etiqueta) ? motorista.etiqueta : [];

          etiquetas.forEach(et => {
            // Detecta se o motorista.etiqueta tem objetos ou só IDs
            const isChecked = Array.isArray(motorista.etiqueta)
              ? motorista.etiqueta.some(e => {
                  // se for lista dentro de lista ([[1], [2]])
                  if (Array.isArray(e)) {
                    return e[0] === et.id;
                  }
                  // fallback para array de objetos {id: X} ou números
                  return e.id === et.id || e === et.id;
                })
              : false;

            const wrapper = document.createElement("div");
            wrapper.classList.add("form-check", "form-check-inline");

            const checkbox = document.createElement("input");
            checkbox.classList.add("form-check-input");
            checkbox.type = "checkbox";
            checkbox.id = `et-${et.id}`;
            checkbox.value = et.id;
            checkbox.checked = isChecked;

            const label = document.createElement("label");
            label.classList.add("form-check-label");
            label.setAttribute("for", `et-${et.id}`);
            label.textContent = et.nome;
            if (et.descricao) label.title = et.descricao;

            wrapper.appendChild(checkbox);
            wrapper.appendChild(label);
            container.appendChild(wrapper);
          });


        // Footer com Desativar + Salvar
       modalFooter.innerHTML = `
          <button type="button" class="btn btn-warning" id="btn-alterar_senha" data-id="${motorista.id}" data-action="btn-alterar_senha">
            Alterar Senha
          </button>
          <button type="button" class="btn btn-danger" id="btn-desativar" data-id="${motorista.id}" data-action="desativar">
            Desativar
          </button>
          <button type="submit" class="btn btn-success">Salvar</button>
        `;

        // Listener de ALTERAR SENHA (igual estilo do desativar)
      modalFooter.querySelector("#btn-alterar_senha").addEventListener("click", async function() {
        const cpf = motorista.cpf;

        if (!cpf) {
          alert("CPF do motorista não encontrado.");
          return;
        }

        if (!confirm(`Deseja realmente redefinir a senha do motorista de CPF ${cpf}?`)) return;

        try {
          const res = await fetch("/admin/redefinir_senha", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cpf })
          });

          const data = await res.json();

          if (data.success) {
            alert(data.message || "Senha redefinida com sucesso!");
          } else {
            alert(data.message || "Erro ao redefinir senha.");
          }
        } catch (err) {
          console.error("Erro ao redefinir senha:", err);
          alert("Falha ao comunicar com o servidor.");
        }
      });

        // Listener de DESATIVAR (sem mudanças)
        modalFooter.querySelector("#btn-desativar").addEventListener("click", async function() {
          const newActive = false;
          const res = await fetch(`/admin/motorista/${motoristaId}/set_active`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ active: newActive })
          });

          const data = await res.json();
          if (res.ok && data.success) location.reload();
          else alert("Erro ao atualizar status do motorista");
        });


      } else {
        // Modal simplificado para motoristas inativos
        modalTitle.textContent = "Motorista Inativo";
        modalBody.innerHTML = `<p>Motorista está inativo. Você pode ativá-lo.</p>`;
        modalFooter.innerHTML = `<button type="button" class="btn btn-success" id="btn-ativar" data-id="${motorista.id}" data-action="ativar">Ativar</button>`;

        // Listener de ativar
        modalFooter.querySelector("#btn-ativar").addEventListener("click", async function() {
          const newActive = true;
          const res = await fetch(`/admin/motorista/${motoristaId}/set_active`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ active: newActive })
          });
          const data = await res.json();
          if (res.ok && data.success) location.reload();
          else alert("Erro ao atualizar status do motorista");
        });
      }

      // Abre o modal
      new bootstrap.Modal(modal).show();

    } catch (err) {
      console.error("Erro ao abrir modal:", err);
      alert("Não foi possível carregar os dados do motorista.");
    }
  });
});

// Submit do formulário de edição
document.getElementById("form-motorista").addEventListener("submit", async function(e) {
  e.preventDefault();
  const motoristaId = document.getElementById("motorista-id").value;
  const etiquetasSelecionadas = [...document.querySelectorAll("#etiqueta-container input:checked")].map(el => parseInt(el.value));

  const payload = {
    nome: document.getElementById("nome").value,
    telefone: document.getElementById("telefone").value,
    cpf: document.getElementById("cpf").value,
    placa: document.getElementById("placa").value,
    etiqueta: etiquetasSelecionadas
  };

  try {
    const res = await fetch(`/motoristas/${motoristaId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      alert("Motorista atualizado com sucesso!");
      window.location.reload();
    } else {
      alert("Erro ao atualizar motorista");
    }
  } catch (err) {
    console.error(err);
    alert("Erro ao atualizar motorista");
  }
});

// Handler global para Ativar/Desativar
document.addEventListener("click", async function(e) {
  if (e.target.id === "btn-desativar" || e.target.id === "btn-ativar") {
    const btn = e.target;
    const motoristaId = btn.dataset.id;
    const isDesativar = btn.dataset.action === "desativar";
    const newActiveState = !isDesativar;

    try {
      const res = await fetch(`/admin/motorista/${motoristaId}/set_active`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ active: newActiveState })
      });

      const data = await res.json();

      if (res.ok && data.success) {
        alert(`Motorista ${data.active ? "ativado" : "desativado"} com sucesso!`);
        window.location.reload();
      } else {
        alert("Erro ao atualizar status do motorista: " + (data.error || "Erro desconhecido"));
      }
    } catch (err) {
      console.error(err);
      alert("Erro na requisição ao atualizar status do motorista");
    }
  }
});
    </script>

    <!-- list js-->
    <script src="{{url_for('static', filename='libs/list.js/list.min.js')}}"></script>
    <script src="{{url_for('static', filename='libs/list.pagination.js/list.pagination.min.js')}}"></script>

    <!-- apexcharts -->
    <script src="{{url_for('static', filename='libs/apexcharts/apexcharts.min.js')}}"></script>

    <!--dashboard learning init js-->
    <script src="{{url_for('static', filename='js/pages/dashboard-learning.init.js')}}"></script>


    <!-- Link para o CSS do Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <!-- Link para o JavaScript do Leaflet -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
      window.valores = {{ valores | safe }};
      window.valores_viagem = {{ valores_viagem | safe }};
      window.api_key = "{{ api_key }}";
      window.motoristas = [
          {% for motorista in motoristas_ativos %}
              { nome: "{{ motorista.nome }}", lat: {{ motorista.lat }}, lon: {{ motorista.lon }}, status: "{{ motorista.status }}" },
          {% endfor %}
      ];


    </script>
    <!-- mapas js -->
    <script src="{{url_for('static', filename='js/maps.js')}}"></script>
      <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places&callback=initAllMaps" async defer></script>

{% endblock extra_js %}

